import {
    MaterialPalette,
} from "../../../material-1.0/ui/styling/material_palette.slint";
import {
    MaterialStyleMetrics,
} from "../../../material-1.0/ui/styling/material_style_metrics.slint";

// Workspace state enum
export enum WorkspaceState {
    Empty,
    Occupied,
    Visible,   // Active on unfocused monitor (darker)
    Active,    // Active on focused monitor (bright)
    Attention,
}

// Data for a single workspace
export struct WorkspaceData {
    id: int,           // Relative ID (1-10) for display
    absolute_id: int,  // Absolute workspace ID for switching
    state: WorkspaceState,
    icon: image,
    occupied: bool,
    prev_occupied: bool,  // Is the previous workspace non-empty?
    next_occupied: bool,  // Is the next workspace non-empty?
}

// Single workspace indicator (clickable)
component WorkspaceIndicator {
    in property <WorkspaceData> data;
    callback clicked(int);

    width: 32px;
    height: 32px;

    touch := TouchArea {
        clicked => {
            root.clicked(data.absolute-id);
        }
    }

    pure function get-vertical-side-border-radius(occupied: bool, neighbor_occupied: bool) -> length {
        if (occupied && neighbor_occupied) {
            return 0px;
        } else {
            return 16px;
        }
    }

    // Background circle
    Rectangle {
        width: parent.width;
        height: parent.height;
        border-top-left-radius: get-vertical-side-border-radius(data.occupied, data.prev_occupied);
        border-bottom-left-radius: get-vertical-side-border-radius(data.occupied, data.prev_occupied);
        border-top-right-radius: get-vertical-side-border-radius(data.occupied, data.next_occupied);
        border-bottom-right-radius: get-vertical-side-border-radius(data.occupied, data.next_occupied);
        background: {
            if data.state == WorkspaceState.Attention {
                MaterialPalette.error
            } else if data.occupied {
                MaterialPalette.surface-container
            } else {
                transparent
            }
        };

        if touch.has-hover: Rectangle {
            width: parent.width;
            height: parent.height;
            border-radius: 16px;
            background: MaterialPalette.surface-container-high;
        }

        if data.state == WorkspaceState.Active: Rectangle {
            width: parent.width;
            height: parent.height;
            border-radius: 16px;
            background: MaterialPalette.primary;
        }

        // Icon or number
        if data.icon.width > 0: Rectangle {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            clip: true;
            Image {
                width: parent.width;
                height: parent.height;
                source: data.icon;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Fallback: show workspace number if no icon
        if data.icon.width == 0: Text {
            text: data.id;
            font-size: 12px;
            color: {
                if data.state == WorkspaceState.Active {
                    MaterialPalette.on-primary
                } else if data.state == WorkspaceState.Attention {
                    MaterialPalette.on-error
                } else if data.state == WorkspaceState.Occupied {
                    MaterialPalette.on-surface
                } else {
                    MaterialPalette.outline
                }
            };
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
}

// Main workspaces component
export component TaskbarWorkspaces {
    in property <[WorkspaceData]> workspaces;
    // Callback when a workspace is clicked (receives absolute workspace ID)
    callback workspace-clicked(int);

    HorizontalLayout {
        spacing: 0px;

        for workspace in workspaces: WorkspaceIndicator {
            data: workspace;
            clicked(id) => {
                root.workspace-clicked(id);
            }
        }
    }
}
