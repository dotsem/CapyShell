import { Icons } from "../../../material-1.0/ui/icons/icons.slint";
import {
    MaterialPalette,
} from "../../../material-1.0/ui/styling/material_palette.slint";

// Battery states matching available Material icons
export enum BatteryState {
    Unknown,        // battery_unknown
    Alert,          // battery_alert (critical, 0-4%)
    Bar0,           // battery_0_bar (5-14%)
    Bar1,           // battery_1_bar (15-29%)
    Bar2,           // battery_2_bar (30-44%)
    Bar3,           // battery_3_bar (45-59%)
    Bar4,           // battery_4_bar (60-74%)
    Bar5,           // battery_5_bar (75-89%)
    Bar6,           // battery_6_bar (90-99%)
    Full,           // battery_full (100%)
    Charging20,     // battery_charging_20 (0-25%)
    Charging30,     // battery_charging_30 (26-50%)
    Charging80,     // battery_charging_80 (51-75%)
    Charging90,     // battery_charging_90 (76-99%)
    ChargingFull,   // battery_full (100% while charging)
}

export struct BatteryData {
    percentage: int,
    state: BatteryState,
    time_remaining: string,
}

export component TaskbarBattery {
    in-out property <BatteryData> data;

    pure function is-charging(s: BatteryState) -> bool {
        return s == BatteryState.Charging20 || s == BatteryState.Charging30 || s == BatteryState.Charging80 || s == BatteryState.Charging90 || s == BatteryState.ChargingFull;
    }

    // Get icon based on state
    pure function get-icon(s: BatteryState) -> image {
        if s == BatteryState.Unknown {
            return Icons.battery_unknown;
        }
        if s == BatteryState.Alert {
            return Icons.battery_alert;
        }
        if s == BatteryState.Bar0 {
            return Icons.battery_0_bar;
        }
        if s == BatteryState.Bar1 {
            return Icons.battery_1_bar;
        }
        if s == BatteryState.Bar2 {
            return Icons.battery_2_bar;
        }
        if s == BatteryState.Bar3 {
            return Icons.battery_3_bar;
        }
        if s == BatteryState.Bar4 {
            return Icons.battery_4_bar;
        }
        if s == BatteryState.Bar5 {
            return Icons.battery_5_bar;
        }
        if s == BatteryState.Bar6 {
            return Icons.battery_6_bar;
        }
        if s == BatteryState.Full {
            return Icons.battery_full;
        }
        if s == BatteryState.Charging20 {
            return Icons.battery_charging_20;
        }
        if s == BatteryState.Charging30 {
            return Icons.battery_charging_30;
        }
        if s == BatteryState.Charging80 {
            return Icons.battery_charging_80;
        }
        if s == BatteryState.Charging90 {
            return Icons.battery_charging_90;
        }
        if s == BatteryState.ChargingFull {
            return Icons.battery_full;
        }
        return Icons.battery_unknown;
    }

    // Get color based on state
    pure function get-color(s: BatteryState) -> color {
        if s == BatteryState.Alert {
            return #ef4444;
        }
        if s == BatteryState.Bar0 {
            return #f97316;
        }
        if s == BatteryState.Bar1 {
            return #eab308;
        }
        if is-charging(s) {
            return #3b82f6;
        }
        if s == BatteryState.Full || s == BatteryState.ChargingFull {
            return #47FB0BFF;
        }
        if s == BatteryState.Unknown {
            return #a855f7;
        }
        // Normal states (discharging)
        return MaterialPalette.on_surface;
    }

    private property <color> battery-color: get-color(root.data.state);

    HorizontalLayout {
        spacing: 6px;
        alignment: center;

        // Percentage and time remaining
        VerticalLayout {
            alignment: center;
            spacing: 2px;
            HorizontalLayout {
                spacing: 4px;
                alignment: end;
                Image {
                    source: Icons.bolt;
                    width: is-charging(root.data.state) ? 20px : 0px;
                    height: 20px;
                    colorize: root.battery-color;
                    animate width { duration: 300ms; }
                }

                Text {
                    text: root.data.percentage + "%";
                    font-size: 12px;
                    color: root.battery-color;
                    font-weight: 600;
                }
            }

            if root.data.time_remaining != "": Text {
                text: root.data.time_remaining;
                font-size: 9px;
                color: #a0a0a0;
                horizontal-alignment: right;
            }
        }

        // Circular indicator with icon
       VerticalLayout {
            alignment: center;
            Rectangle {
                width: 40px;
                height: 40px;
            
            // Background circle
            Rectangle {
                    width: 100%;
                    height: 100%;
                    border-radius: 20px;
                    background: MaterialPalette.surface;
                }

                // Battery Level Arc (Circular Progress)
            Path {
                    width: 100%;
                    height: 100%;
                    viewbox-width: 100;
                    viewbox-height: 100;
                    commands: {
                        if root.data.percentage == 0 {
                            ""
                        } else if root.data.percentage == 100 {
                            "M 50 10 A 40 40 0 1 1 49.99 10"
                        } else {
                            "M 50 10 A 40 40 0 " + (root.data.percentage > 50 ? "1" : "0") + " 1 " + (50 + 40 * sin(root.data.percentage * 3.6deg)) + " " + (50 - 40 * cos(root.data.percentage * 3.6deg))
                        }
                    };
                    stroke: root.battery-color;
                    stroke-width: 2px;
                    fill: transparent;
                }
            
            // Battery Icon
            Image {
                    source: get-icon(root.data.state);
                    width: 20px;
                    height: 20px;
                    x: (parent.width - self.width) / 2;
                    y: (parent.height - self.height) / 2;
                    colorize: root.battery-color;
                }
            }
        }
    }
}
