import {
    MaterialPalette,
} from "../../../material-1.0/ui/styling/material_palette.slint";
import {
    MaterialStyleMetrics,
} from "../../../material-1.0/ui/styling/material_style_metrics.slint";
import {
    StateLayer,
} from "../../../material-1.0/ui/components/state_layer.slint";
import { ProgressBar } from "media/progressBar.slint";
import { MediaData } from "media/mediaDataStruct.slint";
import { StateMetadata } from "media/stateMetadata.slint";
import { StateControls } from "media/stateControls.slint";
import { StateNormal } from "media/stateNormal.slint";



export component MediaWidget inherits Rectangle {
    in property <MediaData> data;
    callback play-pause();
    callback next();
    callback prev();
    callback seek(float); // percent 0..1

    width: 250px; // Default
    height: 48px;
    clip: true;
    border-radius: 8px; // Slight rounding

    property <duration> anim-duration: 200ms;
    
    // Bind properties to TouchAreas defined below
    property <bool> is-hovering-art: art_area.has-hover;
    property <bool> is-hovering-widget: widget_area.has-hover;

    // Background: Blurred Art or dark fallback
    Rectangle {
        width: 100%;
        height: 100%;
        background: #1a1a1a; // Fallback dark background
        
        Image {
            width: 100%;
            height: 100%;
            source: data.blurred_art;
            image-fit: cover;
            visible: data.blurred_art.width > 0;
        }
        
        // Darken overlay for better contrast
        Rectangle {
            background: #000000;
            opacity: 0.3;
        }
    }
    
    // TouchAreas for Hover
    art_area := TouchArea {
        x: 0;
        width: 48px;
        height: 48px;
        mouse-cursor: pointer;
    }

    widget_area := TouchArea {
        x: 48px;
        width: parent.width - 48px;
        height: 48px;
        mouse-cursor: default;
    }

    // === Visualizer (Simple Animated Bars) ===
    HorizontalLayout {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        spacing: 2px;
        padding: 4px;
        opacity: (data.is-playing && !root.is-hovering-widget && !root.is-hovering-art) ? 0.3 : 0.0;
        animate opacity { duration: 200ms; }
        for i in 12: Rectangle {
            horizontal-stretch: 1;
            height: 100%;
            VerticalLayout {
                alignment: end;
                Rectangle {
                    width: 100%;
                    // Use animation-tick directly in radians-like degrees
                    // Each bar has different phase offset (i * 30deg)
                    // Speed controlled by dividing animation-tick
                    height: 8px + 20px * (0.5 + 0.5 * sin((animation-tick() / 100ms) * 1deg + (i * 30deg)));
                    background: data.text-color;
                    opacity: 0.6;
                    border-radius: 2px;
                    animate height { duration: 50ms; }
                }
            }
        }
    }

    // === Layout ===
    HorizontalLayout {
        padding: 0;
        spacing: 0;

        // --- Album Art Section ---
        Rectangle {
            width: 48px;
            height: 48px;
            clip: true;
            border-radius: 8px;
            background: #333333; // Placeholder background when no art
            
            Image {
                width: 100%;
                height: 100%;
                source: data.album_art;
                image-fit: cover;
            }
            
            // Music note icon as placeholder when no art
            Text {
                visible: data.album_art.width == 0;
                text: "â™ª";
                font-size: 24px;
                color: #888888;
                horizontal-alignment: center;
                vertical-alignment: center;
                width: 100%;
                height: 100%;
            }
        }
        
        // --- Content Section ---
        Rectangle {
            width: parent.width - 48px; // Implicit by layout properties usually, but HorizontalLayout children need sizing
            horizontal-stretch: 1;
            height: 48px;
            clip: true;
            StateMetadata {
                data: root.data;
                opacity: root.is-hovering-art ? 1 : 0;
                animate opacity {
                    duration: 200ms;
                    easing: ease-in-out;
                }
            }

            state-controls := StateControls {
                width: 100%;
                height: 100%;
                opacity: !root.is-hovering-art && (root.is-hovering-widget || self.has-hover) ? 1 : 0;
                data: root.data;
                play-pause() => root.play-pause();
                next() => root.next();
                prev() => root.prev();
                seek(val) => root.seek(val);

                animate opacity {
                    duration: 200ms;
                    easing: ease-in-out;
                }
            }

            StateNormal {
                width: 100%;
                height: 100%;
                opacity: !root.is-hovering-art && (!state-controls.has-hover && !root.is-hovering-widget) ? 1 : 0;
                data: root.data;

                animate opacity {
                    duration: 200ms;
                    easing: ease-in-out;
                }
            }
        }
    }
    
    // Helper
   
}
